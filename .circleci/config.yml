version: 2.1
orbs:
  slack: circleci/slack@4.1
  node: circleci/node@4.5.1
executors:
  slack-executor:
    docker:
      - image: cimg/base:stable
    resource_class: small

aliases:
  - &show_branch
    run:
      name: Show current branch after checkout
      command: echo ${CIRCLE_BRANCH}
  - &install_aws_cli
    run:
      name: Installing AWS CLI
      working_directory: /
      command: |
        sudo apt-get -y -qq update
        sudo apt-get install -y awscli
  - &build_project
    run:
      name: Build project
      command: |
        npm run build
        cd public
        zip ../build.zip -r * .[^.]*
        echo "Build successful"
  - &slack_fail_post_step
    post-steps:
      - slack/notify:
          custom: |
            {
              "text": "",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå ${CIRCLE_BRANCH} failed!",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Project*:\n$CIRCLE_PROJECT_REPONAME"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch*:\n$CIRCLE_BRANCH"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*When*:\n$(date +'%m/%d/%Y %T')"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Build*:\n$CIRCLE_BUILD_NUM"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author*:\n$CIRCLE_PROJECT_USERNAME"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Job"
                      },
                      "url": "${CIRCLE_BUILD_URL}"
                    }
                  ]
                }
              ]
            }
          event: fail

jobs:
  install_packages:
    executor: node/default
    steps:
      - checkout
      - *show_branch
      - node/install-packages
  lint:
    executor: node/default
    steps:
      - checkout
      - *show_branch
      - node/install-packages
      - run:
          name: Run linting with ESLint + Prettier
          command: |
            npm run lint
  gatsby_build:
    executor: node/default
    steps:
      - checkout
      - *show_branch
      - node/install-packages
      - *build_project
  deploy_to_aws_s3:
    executor: node/default
    steps:
      - checkout
      - *show_branch
      - *install_aws_cli
      - node/install-packages
      - *build_project
      - run:
          name: Deploy to S3
          command: aws --region ${AWS_REGION} s3 sync ~/project/public s3://${AWS_BUCKET_NAME} --delete
  invalidate_old_cloudfront_distribution:
    executor: node/default
    steps:
      - checkout
      - *show_branch
      - *install_aws_cli
      - run:
          name: Invalidate old Cloudfront distribution, make users re-fetch content
          command: |
            aws configure set preview.cloudfront true
            aws cloudfront create-invalidation --distribution-id ${CF_DISTRIBUTION_ID} --paths /\*
  notify_developers:
    executor: node/default
    steps:
      - slack/notify:
          event: "always"
          channel: "general"
          template: ""
          custom: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${CIRCLE_BRANCH} branch build is complete",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Project*:\n$CIRCLE_PROJECT_REPONAME"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch*:\n$CIRCLE_BRANCH"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*When*:\n$(date +'%m/%d/%Y %T')"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Build*:\n$CIRCLE_BUILD_NUM"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author*:\n$CIRCLE_PROJECT_USERNAME"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Github Repo"
                      },
                      "url": "${GITHUB_REPO_PULL_URL}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Job"
                      },
                      "url": "${CIRCLE_BUILD_URL}"
                    }
                  ]
                }
              ]
            }
workflows:
  build_and_deploy:
    jobs:
      - install_packages:
          <<: *slack_fail_post_step
          context:
            - slack_context
      - lint:
          <<: *slack_fail_post_step
          context:
            - slack_context
          requires:
            - install_packages
          filters: &only_develop
            branches:
              only:
                - develop
      - gatsby_build:
          <<: *slack_fail_post_step
          context:
            - slack_context
          requires:
            - lint
          filters:
            <<: *only_develop
      - notify_developers:
          requires:
            - gatsby_build
          filters:
            <<: *only_develop
          context:
            - slack_context
      ## Our production workflow only relies on package installation, not lint/gatsby_build
      - deploy_to_aws_s3:
          <<: *slack_fail_post_step
          filters: &only_production
            branches:
              only:
                - main
          context:
            - blog_context
            - aws_context
            - slack_context
          requires:
            - install_packages
      - invalidate_old_cloudfront_distribution:
          <<: *slack_fail_post_step
          context:
            - slack_context
            - blog_context
            - aws_context
          requires:
            - deploy_to_aws_s3
          filters:
            <<: *only_production
      - notify_developers:
          requires:
            - invalidate_old_cloudfront_distribution
          filters:
            <<: *only_production
          context:
            - slack_context
